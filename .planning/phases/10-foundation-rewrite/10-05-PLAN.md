---
phase: 10-foundation-rewrite
plan: 05
type: execute
wave: 3
depends_on:
  - 10-02
files_modified:
  - apps/api/src/routes/workflows.ts
  - apps/api/src/tests/routes/workflows-routes.test.ts
  - apps/frontend/src/routes/workflows/+page.svelte
  - apps/frontend/src/routes/workflows/[id]/+page.svelte
  - apps/frontend/src/tests/phase5/workflows.test.ts
autonomous: true
must_haves:
  truths:
    - "Workflow CRUD and execution APIs run entirely on Fastify with RBAC enforcement."
    - "Frontend workflow list and editor fetch data from Fastify endpoints with TanStack Query."
    - "Regression tests verify no imports from SvelteKit workflow `+server` files."
  artifacts:
    - path: "apps/api/src/routes/workflows.ts"
      provides: "Fastify workflow CRUD and execution routes"
    - path: "apps/api/src/tests/routes/workflows-routes.test.ts"
      provides: "Vitest coverage for workflow routes"
    - path: "apps/frontend/src/routes/workflows/[id]/+page.svelte"
      provides: "Workflow editor consuming Fastify APIs"
  key_links:
    - from: "apps/frontend/src/routes/workflows/+page.svelte"
      to: "/api/workflows"
      via: "fetch"
      pattern: "fetch\(.*\/api\/workflows"
    - from: "apps/api/src/routes/workflows.ts"
      to: "@portal/server/workflows"
      via: "workflowRepository"
      pattern: "workflowRepository"
---

<objective>
Port workflow CRUD and execution APIs to Fastify, update the workflow editor to use them, and ensure tests no longer rely on SvelteKit handlers.

Purpose: Unblock workflow designer enhancements and enforce single API boundary per PRD.
Output: Fastify workflow routes, frontend updates, and regression tests.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@apps/api/src/routes/workflows.ts
</context>

<tasks>

<task type="auto">
  <name>Ensure Fastify workflow routes cover CRUD + run</name>
  <files>apps/api/src/routes/workflows.ts</files>
  <action>
  - Implement GET, POST, PUT, DELETE, and run endpoints directly in Fastify using zod schemas sourced from `@portal/types/workflows`.
  - Enforce permissions (`workflows:read/manage/execute`) per route and ensure `resolveOrgId` is applied throughout.
  - Hook executor streaming responses through Fastify for run endpoints.
  - Add Vitest coverage in `apps/api/src/tests/routes/workflows-routes.test.ts` for CRUD + execution flows.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/workflows-routes.test.ts</verify>
  <done>Fastify workflow routes handle CRUD and execution with comprehensive tests.</done>
</task>

<task type="auto">
  <name>Update workflow list and editor pages</name>
  <files>apps/frontend/src/routes/workflows/+page.svelte</files>
  <action>
  - Replace SvelteKit server load dependencies with TanStack Query calls to Fastify `/api/workflows` endpoints.
  - Ensure the workflow editor page (`apps/frontend/src/routes/workflows/[id]/+page.svelte`) loads workflow data via Fastify and handles 404/403 gracefully.
  - Update stores/utilities to consume Fastify responses (including SSE for live runs if already supported).
  </action>
  <verify>pnpm --filter @portal/frontend test --run tests/phase5/workflows.test.ts</verify>
  <done>Workflow list/editor rely on Fastify endpoints and tests validate the integration.</done>
</task>

<task type="auto">
  <name>Remove SvelteKit workflow server imports from tests</name>
  <files>apps/frontend/src/tests/phase5/workflows.test.ts</files>
  <action>
  - Update regression tests to mock Fastify fetch responses instead of importing `routes/api/workflows/+server` modules.
  - Ensure tests still validate schema enforcement, permission errors, and run initiation via mocked SSE responses.
  </action>
  <verify>pnpm --filter @portal/frontend test --run tests/phase5/workflows.test.ts</verify>
  <done>Tests cover workflow flows via Fastify endpoints without referencing SvelteKit server modules.</done>
</task>

</tasks>

<verification>
- `npx vitest run apps/api --run tests/routes/workflows-routes.test.ts`
- `pnpm --filter @portal/frontend test --run tests/phase5/workflows.test.ts`
</verification>

<success_criteria>

- Fastify workflow routes fully replace SvelteKit equivalents with passing backend/frontend tests.
- Workflow pages consume Fastify data sources exclusively.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-05-SUMMARY.md`
</output>
