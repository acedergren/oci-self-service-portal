---
phase: 10-foundation-rewrite
plan: 08
type: execute
wave: 5
depends_on:
  - 10-07
files_modified:
  - packages/server/package.json
  - packages/server/tsconfig.json
  - packages/server/src/index.ts
  - packages/server/src/auth/auth-factory.ts
  - packages/server/src/oracle/connection.ts
  - packages/server/src/workflows/executor.ts
  - packages/shared/src/server/index.ts
  - packages/shared/src/index.ts
  - apps/api/package.json
  - apps/api/tsconfig.json
autonomous: true
must_haves:
  truths:
    - "@portal/server contains all server-only logic formerly in @portal/shared/server."
    - "Apps import server utilities from @portal/server with no Svelte dependencies."
    - "API build/test succeed using the new package."
  artifacts:
    - path: "packages/server/package.json"
      provides: "Dedicated server package manifest"
    - path: "packages/server/src/index.ts"
      provides: "Exports for server-side modules"
    - path: "apps/api/package.json"
      provides: "API workspace dependency list referencing @portal/server"
  key_links:
    - from: "apps/api/src/app.ts"
      to: "@portal/server"
      via: "import"
      pattern: "@portal/server"
    - from: "packages/server/src/index.ts"
      to: "packages/server/src/auth/auth-factory.ts"
      via: "export"
      pattern: "export \* from './auth/auth-factory'"
---

<objective>
Move server-only code (auth, Oracle, workflows, admin repositories) into a new `@portal/server` package and update API imports to use it.

Purpose: Achieve the package split required by the PRD, isolating server concerns from shared/UI code.
Output: `@portal/server` package, updated imports, and green builds/tests.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@packages/shared/src/server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Scaffold @portal/server and relocate server modules</name>
  <files>packages/server/package.json</files>
  <action>
  - Create `packages/server` manifest declaring dependencies on Oracle DB, Better Auth, Pino, Mastra, etc.
  - Move server modules from `packages/shared/src/server/**` into `packages/server/src/**`, updating relative imports and preserving tests if any.
  - Provide re-export barrel in `packages/server/src/index.ts`.
  </action>
  <verify>pnpm --filter @portal/server build</verify>
  <done>`@portal/server` builds successfully with relocated modules.</done>
</task>

<task type="auto">
  <name>Point API workspace at @portal/server</name>
  <files>apps/api/package.json</files>
  <action>
  - Update `apps/api` dependencies and TypeScript paths to consume modules from `@portal/server` instead of `@portal/shared/server`.
  - Adjust import statements across API source files (`apps/api/src/**`) to the new package namespace.
  - Ensure Vitest aliasing resolves `@portal/server` correctly by updating `apps/api/tsconfig.json` and `vitest.config.ts` if needed.
  </action>
  <verify>
    pnpm --filter @portal/api build
    pnpm --filter @portal/api test
  </verify>
  <done>API application compiles and tests pass using the new server package.</done>
</task>

<task type="auto">
  <name>Clean up @portal/shared after extraction</name>
  <files>packages/shared/src/server/index.ts</files>
  <action>
  - Remove server-specific exports from `@portal/shared`, ensuring its build no longer depends on Oracle/Better Auth.
  - Update documentation/export barrels to point consumers to `@portal/server`.
  - Run `pnpm --filter @portal/shared build` to confirm the package has no lingering server dependencies.
  </action>
  <verify>pnpm --filter @portal/shared build</verify>
  <done>`@portal/shared` builds without importing server modules and depends only on shared utilities.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @portal/server build`
- `pnpm --filter @portal/api build`
- `pnpm --filter @portal/api test`
- `pnpm --filter @portal/shared build`
</verification>

<success_criteria>

- Server-only code resides in `@portal/server`, and API imports reflect the new namespace.
- Shared package no longer depends on server-side libraries.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-08-SUMMARY.md`
</output>
