---
phase: 10-foundation-rewrite
plan: 02
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - infrastructure/docker/phase9/nginx.conf
  - apps/frontend/src/hooks.server.ts
  - apps/frontend/src/routes/+layout.server.ts
  - apps/frontend/src/tests/phase10/session-hydration.test.ts
autonomous: true
must_haves:
  truths:
    - "Edge routing sends all /api/* traffic directly to Fastify, disabling SvelteKit proxy behavior."
    - "SvelteKit hydrates auth state by calling Fastify's /api/auth/session endpoint and no longer validates sessions itself."
    - "Regression tests confirm SSR data uses the new Fastify session fetch pathway."
  artifacts:
    - path: "infrastructure/docker/phase9/nginx.conf"
      provides: "Nginx routing rules forwarding /api/ to Fastify port 3001"
    - path: "apps/frontend/src/hooks.server.ts"
      provides: "SvelteKit hook reduced to security headers, logging, and proxy-free behavior"
    - path: "apps/frontend/src/routes/+layout.server.ts"
      provides: "SSR loader fetching session data from Fastify"
    - path: "apps/frontend/src/tests/phase10/session-hydration.test.ts"
      provides: "Frontend Vitest coverage for Fastify-backed session hydration"
  key_links:
    - from: "apps/frontend/src/routes/+layout.server.ts"
      to: "/api/auth/session"
      via: "fetch" call
      pattern: "fetch\(.*\/api\/auth\/session"
    - from: "infrastructure/docker/phase9/nginx.conf"
      to: "api"
      via: "proxy_pass"
      pattern: "location /api/"
---

<objective>
Route all API traffic straight to Fastify and adjust SvelteKit to hydrate auth data via Fastify instead of running Better Auth in hooks.

Purpose: Complete the API boundary separation so SvelteKit handles SSR only, matching PRD expectations.
Output: Updated Nginx config, simplified `hooks.server.ts`, SSR session loader, and regression tests.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@infrastructure/docker/phase9/nginx.conf
@apps/frontend/src/hooks.server.ts
</context>

<tasks>

<task type="auto">
  <name>Update Nginx routing for Fastify-first API</name>
  <files>infrastructure/docker/phase9/nginx.conf</files>
  <action>
  - Modify the `/api/` location block to proxy directly to the Fastify service (`api:3001`) with buffering disabled for SSE.
  - Remove any proxying logic that forwards to SvelteKit or feature-flagged proxies, ensuring headers like `Upgrade` and `X-Request-Id` pass through.
  - Document the route split in comments for future maintainers.
  </action>
  <verify>docker compose -f infrastructure/docker/phase9/docker-compose.yml config</verify>
  <done>Nginx forwards `/api/*` to Fastify port 3001 exclusively with configuration validation succeeding.</done>
</task>

<task type="auto">
  <name>Simplify SvelteKit hooks to remove auth validation</name>
  <files>apps/frontend/src/hooks.server.ts</files>
  <action>
  - Strip Better Auth validation logic from the handle hook, retaining only shared concerns (logging, rate limiting, security headers).
  - Ensure `/api/v1/` CORS and rate limiting logic still executes for external API consumers.
  - Forward request IDs and security headers without modifying `/api/*` routing, reflecting Fastify's responsibility for auth.
  </action>
  <verify>pnpm --filter @portal/frontend lint</verify>
  <done>`hooks.server.ts` no longer calls Better Auth APIs and contains only cross-cutting concerns.</done>
</task>

<task type="auto">
  <name>Hydrate session via Fastify in root layout</name>
  <files>apps/frontend/src/routes/+layout.server.ts</files>
  <action>
  - Fetch `/api/auth/session` using the incoming request cookies to retrieve user/session data from Fastify.
  - Handle 200 (authed) and 401 (guest) responses, returning consistent page data for client hydration.
  - Capture errors via `PortalError` helpers and surface them as 503 with user-friendly messaging.
  - Create Vitest coverage in `apps/frontend/src/tests/phase10/session-hydration.test.ts` to assert the new fetch logic executes and handles error branches.
  </action>
  <verify>pnpm --filter @portal/frontend test --run tests/phase10/session-hydration.test.ts</verify>
  <done>Root layout server load relies on `/api/auth/session`, with passing tests covering auth and guest flows.</done>
</task>

</tasks>

<verification>
- `docker compose -f infrastructure/docker/phase9/docker-compose.yml config`
- `pnpm --filter @portal/frontend lint`
- `pnpm --filter @portal/frontend test --run tests/phase10/session-hydration.test.ts`
</verification>

<success_criteria>

- `/api/*` traffic bypasses SvelteKit entirely.
- SvelteKit SSR loads session data from Fastify without embedded auth logic.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-02-SUMMARY.md`
</output>
