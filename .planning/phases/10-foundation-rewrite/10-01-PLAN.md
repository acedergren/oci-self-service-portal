---
phase: 10-foundation-rewrite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routes/auth.ts
  - apps/api/src/plugins/auth.ts
  - apps/api/src/tests/routes/auth-routes.test.ts
autonomous: true
must_haves:
  truths:
    - "Fastify handles all /api/auth/* requests directly, delegating to the Better Auth handler without SvelteKit involvement."
    - "Session and API key authentication decorate Fastify requests with user, session, and permissions data before route handlers execute."
    - "Regression tests cover GET and POST flows through the new Fastify auth boundary."
  artifacts:
    - path: "apps/api/src/routes/auth.ts"
      provides: "Catch-all Fastify route that forwards requests to Better Auth"
      exports: ["default"]
    - path: "apps/api/src/plugins/auth.ts"
      provides: "Fastify plugin registering Better Auth session/API key validation"
    - path: "apps/api/src/tests/routes/auth-routes.test.ts"
      provides: "Vitest coverage for Fastify authentication routes"
  key_links:
    - from: "apps/api/src/routes/auth.ts"
      to: "@portal/server/auth/auth-factory"
      via: "auth.handler(request) call"
      pattern: "auth\.handler\("
    - from: "apps/api/src/plugins/auth.ts"
      to: "apps/api/src/routes/auth.ts"
      via: "fastify.register(import('./routes/auth.js'))"
      pattern: "register\(.*auth"
---

<objective>
Consolidate authentication inside Fastify by exposing a Better Auth-powered `/api/auth/*` catch-all route and ensuring session/API key decorators run before any downstream handler.

Purpose: Eliminate the dual auth boundary described in the PRD so all authentication decisions live within the Fastify layer.
Output: Hardened Fastify auth plugin, Better Auth route handler, and route tests proving the integration.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@apps/api/src/plugins/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Wire Better Auth handler into Fastify</name>
  <files>apps/api/src/routes/auth.ts</files>
  <action>
  - Create or refactor the auth route module to expose a Fastify route definition handling both GET and POST requests at `/api/auth/*`.
  - Convert the incoming Fastify request to a Fetch-compatible Request via the existing `toWebRequest` utility so `auth.handler` can process it without leaking Fastify internals.
  - Forward response status, headers (including Set-Cookie), and body back through `reply` while preserving streaming support for 302 redirects and JSON payloads.
  - Ensure trusted origins are validated against `FRONTEND_URL` and audit log entries are emitted via the logger.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/auth-routes.test.ts</verify>
  <done>Fastify responds to GET/POST `/api/auth/*` by delegating to Better Auth, preserving cookies and status codes.</done>
</task>

<task type="auto">
  <name>Unify session and API key decorators</name>
  <files>apps/api/src/plugins/auth.ts</files>
  <action>
  - Adjust the auth plugin to remove any SvelteKit-specific conditionals and ensure session validation uses the Better Auth instance from `@portal/server/auth/auth-factory`.
  - Decorate `request.user`, `request.session`, `request.permissions`, and `request.apiKeyContext` prior to `onRequest` hooks, throwing PortalError variants when authentication fails.
  - Register the new `/api/auth/*` route module within the plugin registration order after middleware but before RBAC, maintaining load-bearing plugin order.
  - Update logging to include `opcRequestId` for downstream Oracle calls and align with PRD security expectations.
  </action>
  <verify>npx vitest run apps/api --run tests/plugins/auth.test.ts</verify>
  <done>Fastify auth plugin decorates requests via Better Auth for both session and API key flows and registers the new route without altering plugin order.</done>
</task>

<task type="auto">
  <name>Add regression coverage for Fastify auth boundary</name>
  <files>apps/api/src/tests/routes/auth-routes.test.ts</files>
  <action>
  - Write Vitest cases hitting `/api/auth/callback` (OIDC) and `/api/auth/session` to assert Set-Cookie headers, CSRF tokens, and error propagation are handled through Fastify.
  - Mock Better Auth using the existing forwarding pattern so tests remain stable with `mockReset: true`.
  - Include failure scenarios (invalid origin, missing session) to ensure PortalError responses map to expected HTTP codes.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/auth-routes.test.ts</verify>
  <done>Tests cover success and failure flows for the Fastify auth route, ensuring cookies and error codes match Better Auth responses.</done>
</task>

</tasks>

<verification>
- `npx vitest run apps/api --run tests/routes/auth-routes.test.ts`
- `npx vitest run apps/api --run tests/plugins/auth.test.ts`
</verification>

<success_criteria>

- `/api/auth/*` is served exclusively by Fastify with passing Vitest coverage.
- Auth plugin sets request decorators via Better Auth without regressions.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-01-SUMMARY.md`
</output>
