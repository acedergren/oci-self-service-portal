---
phase: 10-foundation-rewrite
plan: 03
type: execute
wave: 3
depends_on:
  - 10-02
files_modified:
  - apps/api/src/routes/chat.ts
  - apps/api/src/routes/tools/approve.ts
  - apps/api/src/tests/routes/chat-routes.test.ts
  - apps/frontend/src/lib/components/chat/ai-context.svelte.ts
  - apps/frontend/src/routes/admin/agents/+page.svelte
  - apps/frontend/src/tests/phase4/medium-findings.test.ts
  - apps/frontend/src/tests/phase6/cors-v1-api.test.ts
  - apps/frontend/src/tests/auth/session-flow.test.ts
autonomous: true
must_haves:
  truths:
    - "Chat POST requests hit Fastify directly and return streaming responses without SvelteKit proxies."
    - "Chat approval endpoints reside under Fastify tooling routes, enforcing RBAC and audit logging."
    - "Frontend code paths and regression tests target the Fastify endpoints with no imports from `routes/api/chat/+server`."
  artifacts:
    - path: "apps/api/src/routes/chat.ts"
      provides: "Fastify chat API supporting send, list, session detail, and SSE stream"
    - path: "apps/api/src/routes/tools/approve.ts"
      provides: "Chat approval/rejection endpoints under Fastify"
    - path: "apps/api/src/tests/routes/chat-routes.test.ts"
      provides: "Vitest regression coverage for chat Fastify routes"
    - path: "apps/frontend/src/lib/components/chat/ai-context.svelte.ts"
      provides: "Chat client configured with Fastify endpoints"
  key_links:
    - from: "apps/frontend/src/lib/components/chat/ai-context.svelte.ts"
      to: "/api/chat"
      via: "fetch"
      pattern: "fetch\(\s*'/api/chat'"
    - from: "apps/api/src/routes/chat.ts"
      to: "@portal/server/agent-state"
      via: "chatSessionRepository"
      pattern: "chatSessionRepository"
---

<objective>
Retire the remaining SvelteKit chat APIs by ensuring Fastify owns chat messaging, approval, and session management, with frontend clients and tests updated accordingly.

Purpose: Align chat flows with the unified API boundary and satisfy PRD success criteria for zero SvelteKit API routes.
Output: Hardened Fastify chat routes, updated frontend clients, and regression tests referencing the new endpoints.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@apps/api/src/routes/chat.ts
</context>

<tasks>

<task type="auto">
  <name>Complete Fastify chat route parity</name>
  <files>apps/api/src/routes/chat.ts</files>
  <action>
  - Audit existing Fastify chat handlers and ensure they implement the payload validation, session management, and streaming responses that currently live in the SvelteKit `+server` implementation.
  - Wire the chat route through `requirePermission('chat:write')` and reuse the existing tool approval logic via shared services.
  - Return SSE or chunked responses for streaming message output, aligning with Mastra agent expectations.
  - Expand Vitest coverage in `apps/api/src/tests/routes/chat-routes.test.ts` to prove parity for send, list, session detail, and SSE flows, using the counter-based mock pattern for Oracle interactions.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/chat-routes.test.ts</verify>
  <done>Fastify chat route matches the former SvelteKit behavior and passes targeted Vitest coverage.</done>
</task>

<task type="auto">
  <name>Migrate chat approvals and retire SvelteKit endpoints</name>
  <files>apps/api/src/routes/tools/approve.ts</files>
  <action>
  - Relocate approval/reject handlers from SvelteKit to Fastifyâ€™s `/api/chat/approve` and `/api/chat/reject` routes, enforcing RBAC (`tools:execute`).
  - Ensure audit logs capture agent action, org ID, and decision reason.
  - Remove or stub any SvelteKit `+server` modules for approvals, replacing imports in frontend code with standard fetch calls to Fastify endpoints.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/chat-routes.test.ts</verify>
  <done>Approval flows execute through Fastify endpoints with SvelteKit approval handlers removed.</done>
</task>

<task type="auto">
  <name>Update frontend chat clients and regression tests</name>
  <files>apps/frontend/src/lib/components/chat/ai-context.svelte.ts</files>
  <action>
  - Refactor chat client utilities and admin playgrounds to call Fastify endpoints directly, removing imports of `routes/api/chat/+server` modules.
  - Update tests in `apps/frontend/src/tests/phase4/medium-findings.test.ts`, `apps/frontend/src/tests/phase6/cors-v1-api.test.ts`, and `apps/frontend/src/tests/auth/session-flow.test.ts` to stub Fastify responses instead of SvelteKit handlers.
  - Ensure admin agent playground uses the same chat client abstraction so both admin and portal views share Fastify-backed behavior.
  </action>
  <verify>pnpm --filter @portal/frontend test --run tests/phase4/medium-findings.test.ts tests/phase6/cors-v1-api.test.ts tests/auth/session-flow.test.ts</verify>
  <done>Frontend chat paths exclusively reference Fastify endpoints with updated Vitest coverage.</done>
</task>

</tasks>

<verification>
- `npx vitest run apps/api --run tests/routes/chat-routes.test.ts`
- `pnpm --filter @portal/frontend test --run tests/phase4/medium-findings.test.ts tests/phase6/cors-v1-api.test.ts tests/auth/session-flow.test.ts`
</verification>

<success_criteria>

- Chat messaging and approvals operate solely through Fastify endpoints with passing backend/frontend tests.
- No frontend module imports `routes/api/chat/+server`.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-03-SUMMARY.md`
</output>
