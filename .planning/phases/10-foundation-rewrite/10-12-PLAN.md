---
phase: 10-foundation-rewrite
plan: 12
type: execute
wave: 9
depends_on:
  - 10-08
  - 10-11
files_modified:
  - packages/server/src/workflows/executor.ts
  - packages/server/src/workflows/runtime.ts
  - packages/server/src/workflows/types.ts
  - apps/api/src/tests/workflows/executor.test.ts
  - apps/api/src/tests/workflows/runtime.test.ts
autonomous: true
must_haves:
  truths:
    - 'Workflow executor supports AI Step, Loop, Parallel, and compensation nodes using Mastra primitives.'
    - 'Retry policies with exponential backoff are configurable per tool node.'
    - 'Streaming events emit step lifecycle notifications consumable by SSE endpoints.'
  artifacts:
    - path: 'packages/server/src/workflows/executor.ts'
      provides: 'Enhanced workflow executor implementation'
    - path: 'apps/api/src/tests/workflows/executor.test.ts'
      provides: 'Unit tests covering new node behaviors'
  key_links:
    - from: 'packages/server/src/workflows/executor.ts'
      to: '@mastra/core/workflows'
      via: 'createWorkflow'
      pattern: 'createWorkflow'
    - from: 'apps/api/src/tests/workflows/executor.test.ts'
      to: 'packages/server/src/workflows/executor.ts'
      via: 'import'
      pattern: "from '@portal/server/workflows/executor'"
---

<objective>
Enhance the backend workflow executor to implement the remaining node types, retries, compensation, and streaming needed for the visual designer.

Purpose: Unlock workflow designer completion and admin observability per PRD.
Output: Updated executor/runtime modules with comprehensive tests.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@packages/server/src/workflows/executor.ts
</context>

<tasks>

<task type="auto">
  <name>Add Mastra primitives for AI, Loop, and Parallel nodes</name>
  <files>packages/server/src/workflows/executor.ts</files>
  <action>
  - Extend executor to build workflows using Mastra `.then`, `.parallel`, `.foreach`, `.branch`, and `.dountil` primitives based on node definitions.
  - Ensure AI Step nodes configure model, prompt template, and output schema using `@portal/server/mastra` helpers.
  - Implement aggregation for Loop nodes and named results for Parallel branches.
  </action>
  <verify>pnpm --filter @portal/server build</verify>
  <done>Executor constructs workflows covering AI, Loop, Parallel, and Branch nodes using Mastra primitives.</done>
</task>

<task type="auto">
  <name>Implement retries, compensation, and streaming</name>
  <files>packages/server/src/workflows/runtime.ts</files>
  <action>
  - Add retry policies with exponential backoff for tool nodes using configuration from workflow definitions.
  - Introduce compensation handlers executed in reverse order on failure.
  - Emit streaming events (`step-start`, `step-complete`, `step-error`) for SSE consumers.
  </action>
  <verify>pnpm --filter @portal/server build</verify>
  <done>Runtime handles retries, compensation, and streaming events per PRD requirements.</done>
</task>

<task type="auto">
  <name>Expand workflow executor tests</name>
  <files>apps/api/src/tests/workflows/executor.test.ts</files>
  <action>
  - Add coverage for AI Step, Loop, Parallel, compensation, and retry flows using counter-based mocks.
  - Validate streaming events and ensure failure cases trigger compensation.
  - Create separate runtime tests (`apps/api/src/tests/workflows/runtime.test.ts`) for resume/suspend scenarios.
  </action>
  <verify>npx vitest run apps/api --run tests/workflows/executor.test.ts tests/workflows/runtime.test.ts</verify>
  <done>Tests cover new node types, retries, compensation, and streaming events.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @portal/server build`
- `npx vitest run apps/api --run tests/workflows/executor.test.ts tests/workflows/runtime.test.ts`
</verification>

<success_criteria>

- Workflow executor supports all node types, retries, compensation, and streaming with passing tests.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-12-SUMMARY.md`
</output>
