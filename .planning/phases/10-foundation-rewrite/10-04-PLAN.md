---
phase: 10-foundation-rewrite
plan: 04
type: execute
wave: 3
depends_on:
  - 10-02
files_modified:
  - apps/api/src/routes/tools.ts
  - apps/api/src/routes/tools/execute.ts
  - apps/api/src/tests/routes/tools-execute.test.ts
  - apps/frontend/src/routes/+page.svelte
  - apps/frontend/src/tests/phase4/execute-endpoint.test.ts
autonomous: true
must_haves:
  truths:
    - "Tool listing and execution operations are served from Fastify without SvelteKit wrappers."
    - "Tool execution enforces RBAC permissions and returns structured errors with opc-request-id where applicable."
    - "Frontend portal uses Fastify `/api/tools/execute` and regression tests no longer import SvelteKit `+server` modules."
  artifacts:
    - path: "apps/api/src/routes/tools.ts"
      provides: "Fastify route module exposing tool list and metadata endpoints"
    - path: "apps/api/src/routes/tools/execute.ts"
      provides: "Fastify tool execution handler"
    - path: "apps/api/src/tests/routes/tools-execute.test.ts"
      provides: "Vitest coverage for tool execution via Fastify"
    - path: "apps/frontend/src/tests/phase4/execute-endpoint.test.ts"
      provides: "Frontend regression coverage referencing Fastify tools API"
  key_links:
    - from: "apps/frontend/src/routes/+page.svelte"
      to: "/api/tools/execute"
      via: "fetch"
      pattern: "fetch\(\s*`?/api/tools/execute"
    - from: "apps/api/src/routes/tools/execute.ts"
      to: "@portal/server/tools/executor"
      via: "executeTool"
      pattern: "executeTool"
---

<objective>
Shift tool listing/execution endpoints to Fastify, retire SvelteKit `+server` handlers, and update portal fetch logic and tests accordingly.

Purpose: Meet PRD requirement for zero SvelteKit API routes while leveraging Fastify's auth and logging for tool execution.
Output: Fastify tool routes, refreshed frontend fetches, and Vitest coverage.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@apps/api/src/routes/tools.ts
</context>

<tasks>

<task type="auto">
  <name>Expand Fastify tool list and metadata endpoints</name>
  <files>apps/api/src/routes/tools.ts</files>
  <action>
  - Implement GET `/api/tools` and `/api/v1/tools` directly in Fastify, returning tool metadata from the shared catalog with proper zod validation.
  - Remove reliance on SvelteKit proxies and ensure RBAC enforcement (`tools:read`).
  - Log requests with request ID and opc-request-id for downstream calls.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/tools-execute.test.ts</verify>
  <done>Tool metadata endpoints run entirely on Fastify with validation and RBAC checks.</done>
</task>

<task type="auto">
  <name>Finalize Fastify tool execution handler</name>
  <files>apps/api/src/routes/tools/execute.ts</files>
  <action>
  - Move POST `/api/tools/execute` logic from SvelteKit to Fastify, using the shared executor and capturing opc-request-id in error responses.
  - Enforce `tools:execute` permission, session resolution, and approval workflows (if flagged) before running tools.
  - Update Vitest coverage in `apps/api/src/tests/routes/tools-execute.test.ts` to validate success, approval-required, and error paths using the counter-based mock implementation.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/tools-execute.test.ts</verify>
  <done>Tool execution occurs via Fastify with comprehensive backend tests.</done>
</task>

<task type="auto">
  <name>Update portal fetch logic and frontend tests</name>
  <files>apps/frontend/src/routes/+page.svelte</files>
  <action>
  - Ensure portal chat/tool UI fetches `/api/tools/execute` directly, handling streaming responses and structured errors from Fastify.
  - Replace imports of `routes/api/tools/execute/+server` with fetch stubs in `apps/frontend/src/tests/phase4/execute-endpoint.test.ts`.
  - Update tests to mock Fastify responses, verifying request headers (X-Request-Id, Authorization) and response handling.
  </action>
  <verify>pnpm --filter @portal/frontend test --run tests/phase4/execute-endpoint.test.ts</verify>
  <done>Frontend uses the Fastify tools endpoint with updated regression coverage and no reliance on SvelteKit modules.</done>
</task>

</tasks>

<verification>
- `npx vitest run apps/api --run tests/routes/tools-execute.test.ts`
- `pnpm --filter @portal/frontend test --run tests/phase4/execute-endpoint.test.ts`
</verification>

<success_criteria>

- Tool metadata and execution routes run exclusively in Fastify with passing backend/frontend tests.
- No frontend tests import SvelteKit `+server` files for tools.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-04-SUMMARY.md`
</output>
