---
phase: 10-foundation-rewrite
plan: 10
type: execute
wave: 7
depends_on:
  - 10-08
files_modified:
  - packages/server/src/tools/executor-sdk.ts
  - packages/server/src/tools/index.ts
  - packages/server/src/tools/config.ts
  - apps/api/src/tests/tools/oci-sdk-executor.test.ts
  - packages/server/src/tools/__mocks__/oci-sdk.ts
autonomous: true
must_haves:
  truths:
    - "Tool execution uses the OCI TypeScript SDK with connection pooling and retries."
    - "SDK authentication supports config file and instance principals."
    - "Vitest coverage validates happy path and error enrichment with opc-request-id."
  artifacts:
    - path: "packages/server/src/tools/executor-sdk.ts"
      provides: "SDK-backed tool execution pipeline"
    - path: "apps/api/src/tests/tools/oci-sdk-executor.test.ts"
      provides: "Unit tests for SDK executor"
  key_links:
    - from: "packages/server/src/tools/index.ts"
      to: "packages/server/src/tools/executor-sdk.ts"
      via: "export"
      pattern: "export \{ createOciSdkExecutor \}"
    - from: "packages/server/src/tools/executor-sdk.ts"
      to: "oci-sdk"
      via: "import"
      pattern: "from 'oci-sdk'"
---

<objective>
Replace CLI-based tool execution with an OCI SDK-based executor that offers typed responses, pooling, and structured error handling.

Purpose: Achieve the PRD latency and reliability goals for OCI tool calls.
Output: SDK executor, config hooks, and tests.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@packages/server/src/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Implement OCI SDK executor</name>
  <files>packages/server/src/tools/executor-sdk.ts</files>
  <action>
  - Create `createOciSdkExecutor` that loads OCI config (`~/.oci/config`) or instance principal credentials with retry/configurable timeouts.
  - Implement tracing hooks to capture latency and include `opc-request-id` in logs.
  - Ensure executor returns parsed JSON results matching existing ToolResponse types.
  </action>
  <verify>pnpm --filter @portal/server build</verify>
  <done>SDK executor compiles and exposes typed interface.</done>
</task>

<task type="auto">
  <name>Add configuration and export wiring</name>
  <files>packages/server/src/tools/index.ts</files>
  <action>
  - Export the new executor and update any factory functions to select SDK-based execution.
  - Add configuration module for region/profile selection (`packages/server/src/tools/config.ts`).
  - Ensure fallback logic surfaces clear errors when credentials missing.
  </action>
  <verify>pnpm --filter @portal/server build</verify>
  <done>SDK executor is wired through tool entrypoints with configuration options.</done>
</task>

<task type="auto">
  <name>Write Vitest coverage for SDK executor</name>
  <files>apps/api/src/tests/tools/oci-sdk-executor.test.ts</files>
  <action>
  - Mock `oci-sdk` using counter-based pattern to simulate success, throttling, and service errors.
  - Assert executor wraps errors with `OCIError` including service name, status, `opc-request-id`.
  - Verify retries/backoff logic triggers per configuration.
  </action>
  <verify>npx vitest run apps/api --run tests/tools/oci-sdk-executor.test.ts</verify>
  <done>Tests validate success and failure flows of the SDK executor.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @portal/server build`
- `npx vitest run apps/api --run tests/tools/oci-sdk-executor.test.ts`
</verification>

<success_criteria>

- Tool execution uses OCI SDK with tests verifying functionality and error enrichment.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-10-SUMMARY.md`
</output>
