---
phase: 10-foundation-rewrite
plan: 16
type: execute
wave: 13
depends_on:
  - 10-12
  - 10-06
files_modified:
  - apps/api/src/routes/admin/agents.ts
  - apps/api/src/routes/admin/workflow-runs.ts
  - apps/api/src/routes/admin/tools-playground.ts
  - apps/api/src/plugins/mastra.ts
  - apps/api/src/tests/routes/admin-agents.test.ts
  - apps/api/src/tests/routes/admin-workflow-runs.test.ts
autonomous: true
must_haves:
  truths:
    - 'Admin SSE endpoints stream agent chat and workflow run events.'
    - 'Mastra Studio mounted under /admin/studio with RBAC gating.'
    - 'Tests verify SSE permissions and Studio access rules.'
  artifacts:
    - path: 'apps/api/src/routes/admin/agents.ts'
      provides: 'Admin agent SSE playground routes'
    - path: 'apps/api/src/plugins/mastra.ts'
      provides: 'Mastra configuration exposing Studio'
    - path: 'apps/api/src/tests/routes/admin-agents.test.ts'
      provides: 'SSE test coverage'
  key_links:
    - from: 'apps/api/src/routes/admin/agents.ts'
      to: '@portal/server/mastra'
      via: 'import'
      pattern: 'Mastra'
    - from: 'apps/api/src/plugins/mastra.ts'
      to: '/admin/studio'
      via: 'studioBase'
      pattern: "studioBase: '/admin/studio'"
---

<objective>
Expose admin SSE endpoints for agent/workflow monitoring and mount Mastra Studio within Fastify, gated by admin permissions.

Purpose: Deliver admin observability and tooling per PRD before UI work.
Output: Admin Fastify routes, Mastra plugin updates, and regression tests.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@apps/api/src/plugins/mastra.ts
</context>

<tasks>

<task type="auto">
  <name>Create admin SSE routes for agents and workflows</name>
  <files>apps/api/src/routes/admin/agents.ts</files>
  <action>
  - Implement `/api/admin/agents/:id/stream` providing SSE events from Mastra agent runs.
  - Add `/api/admin/workflows/runs/:runId/stream` to emit workflow run lifecycle events.
  - Enforce `admin:all` permission, returning 403 otherwise.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/admin-agents.test.ts tests/routes/admin-workflow-runs.test.ts</verify>
  <done>SSE routes stream agent and workflow events with RBAC checks.</done>
</task>

<task type="auto">
  <name>Mount Mastra Studio under /admin/studio</name>
  <files>apps/api/src/plugins/mastra.ts</files>
  <action>
  - Configure Mastra plugin `studioBase` to `/admin/studio` and wrap access with RBAC guard requiring `admin:all` outside development.
  - Expose configuration toggles for environment-based enablement.
  </action>
  <verify>pnpm --filter @portal/api build</verify>
  <done>Mastra Studio accessible at `/admin/studio` with RBAC gating.</done>
</task>

<task type="auto">
  <name>Add admin SSE regression tests</name>
  <files>apps/api/src/tests/routes/admin-agents.test.ts</files>
  <action>
  - Write tests covering SSE stream handshake, RBAC denials, and event payload formatting for agents and workflow runs.
  - Ensure tests mock Mastra stream iterators to emit sample events.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/admin-agents.test.ts tests/routes/admin-workflow-runs.test.ts</verify>
  <done>Tests validate access control and streaming output for admin endpoints.</done>
</task>

</tasks>

<verification>
- `npx vitest run apps/api --run tests/routes/admin-agents.test.ts tests/routes/admin-workflow-runs.test.ts`
- `pnpm --filter @portal/api build`
</verification>

<success_criteria>

- Admin SSE endpoints and Mastra Studio integration function with passing tests and RBAC enforcement.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-16-SUMMARY.md`
</output>
