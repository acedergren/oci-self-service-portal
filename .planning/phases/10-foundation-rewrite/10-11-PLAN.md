---
phase: 10-foundation-rewrite
plan: 11
type: execute
wave: 8
depends_on:
  - 10-10
files_modified:
  - packages/server/src/tools/registry.ts
  - packages/server/src/tools/categories/index.ts
  - packages/server/src/tools/categories/compute.ts
  - packages/server/src/tools/categories/networking.ts
  - packages/server/src/tools/categories/storage.ts
  - packages/server/src/tools/categories/observability.ts
  - packages/server/src/tools/categories/database.ts
  - packages/server/src/tools/categories/billing.ts
  - packages/server/src/tools/categories/identity.ts
  - packages/server/src/tools/categories/pricing.ts
  - apps/api/src/tests/routes/tools-execute.test.ts
autonomous: true
must_haves:
  truths:
    - "All tool categories invoke the OCI SDK executor."
    - "CLI subprocess invocation is removed from tool execution path."
    - "Regression tests validate response latencies and error propagation via SDK."
  artifacts:
    - path: "packages/server/src/tools/registry.ts"
      provides: "Tool registry pointing to SDK executor"
    - path: "packages/server/src/tools/categories/index.ts"
      provides: "Category exports bound to SDK executor"
    - path: "apps/api/src/tests/routes/tools-execute.test.ts"
      provides: "Integration tests verifying SDK-backed tool execution"
  key_links:
    - from: "packages/server/src/tools/registry.ts"
      to: "createOciSdkExecutor"
      via: "import"
      pattern: "createOciSdkExecutor"
    - from: "apps/api/src/tests/routes/tools-execute.test.ts"
      to: "createOciSdkExecutor"
      via: "vi.mock"
      pattern: "vi\.mock.*createOciSdkExecutor"
---

<objective>
Update every tool category and registry to rely on the new OCI SDK executor, eliminating CLI subprocesses and ensuring tests reflect the change.

Purpose: Meet the PRD latency improvements and provide typed responses for all tool calls.
Output: Updated tool registry/categories and passing tests.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@packages/server/src/tools/registry.ts
</context>

<tasks>

<task type="auto">
  <name>Refactor tool registry to use SDK executor</name>
  <files>packages/server/src/tools/registry.ts</files>
  <action>
  - Inject `createOciSdkExecutor` into registry factory, replacing CLI executor references.
  - Ensure lazy initialization is cached per request to reuse SDK clients.
  - Remove CLI-specific error parsing code.
  </action>
  <verify>pnpm --filter @portal/server build</verify>
  <done>Tool registry references SDK executor exclusively and compiles.</done>
</task>

<task type="auto">
  <name>Update tool categories to call SDK executor</name>
  <files>packages/server/src/tools/categories/index.ts</files>
  <action>
  - For each category module (compute, networking, storage, observability, database, billing, identity, pricing), replace CLI spawn calls with SDK executor invocations.
  - Ensure tool definitions map to correct SDK service methods and handle structured responses.
  - Remove CLI-specific parsing helpers now obsolete.
  </action>
  <verify>pnpm --filter @portal/server build</verify>
  <done>All tool categories compile using the SDK executor.</done>
</task>

<task type="auto">
  <name>Refresh integration tests for tool execution</name>
  <files>apps/api/src/tests/routes/tools-execute.test.ts</files>
  <action>
  - Update tests to mock the SDK executor, validating success, failure, and latency metrics (<500 ms target) via timers or mock timestamps.
  - Ensure error cases assert `OCIError` contents (service name, status, opc-request-id).
  - Confirm no tests import CLI helpers.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/tools-execute.test.ts</verify>
  <done>Integration tests confirm SDK executor behavior and no CLI dependencies remain.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @portal/server build`
- `npx vitest run apps/api --run tests/routes/tools-execute.test.ts`
</verification>

<success_criteria>

- Tool execution path uses OCI SDK exclusively with updated tests demonstrating success/error coverage.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-11-SUMMARY.md`
</output>
