---
phase: 10-foundation-rewrite
plan: 06
type: execute
wave: 3
depends_on:
  - 10-02
files_modified:
  - apps/api/src/routes/sessions.ts
  - apps/api/src/routes/setup.ts
  - apps/api/src/routes/webhooks.ts
  - apps/api/src/routes/admin/mcp.ts
  - apps/api/src/routes/admin/metrics.ts
  - apps/api/src/tests/routes/sessions-routes.test.ts
  - apps/api/src/tests/routes/setup-routes.test.ts
  - apps/api/src/tests/routes/webhooks-routes.test.ts
  - apps/frontend/src/tests/phase4/setup-wizard.test.ts
  - apps/frontend/src/tests/phase6/webhooks.test.ts
autonomous: true
must_haves:
  truths:
    - "Session list and management APIs run only in Fastify with RBAC enforcement."
    - "Setup wizard endpoints (test connection, create admin) operate via Fastify without SvelteKit proxies."
    - "Admin configuration and webhook APIs leverage Fastify routes and frontend regression tests reference them accordingly."
  artifacts:
    - path: "apps/api/src/routes/sessions.ts"
      provides: "Fastify session management routes"
    - path: "apps/api/src/routes/setup.ts"
      provides: "Fastify setup wizard endpoints"
    - path: "apps/api/src/routes/webhooks.ts"
      provides: "Fastify webhook CRUD and test endpoints"
    - path: "apps/api/src/routes/admin/mcp.ts"
      provides: "Fastify admin MCP management routes"
  key_links:
    - from: "apps/api/src/routes/sessions.ts"
      to: "@portal/server/session"
      via: "sessionRepository"
      pattern: "sessionRepository"
    - from: "apps/frontend/src/tests/phase6/webhooks.test.ts"
      to: "/api/webhooks"
      via: "fetch"
      pattern: "fetch\(.*\/api\/webhooks"
---

<objective>
Complete Fastify ownership of remaining SvelteKit API routes covering sessions, setup, admin MCP/settings, and webhooks, updating tests to remove SvelteKit dependencies.

Purpose: Finish the API consolidation required by the PRD, preparing for package splits and admin experience work.
Output: Fastify routes for sessions/setup/webhooks/admin, with updated frontend/backend regression tests.
</objective>

<execution_context>
@/Users/acedergr/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/acedergr/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.claude/reference/PRD.md
@apps/api/src/routes/sessions.ts
</context>

<tasks>

<task type="auto">
  <name>Migrate session management to Fastify</name>
  <files>apps/api/src/routes/sessions.ts</files>
  <action>
  - Ensure GET `/api/sessions` and `/api/sessions/:id` routes exist in Fastify, leverage `sessionRepository`, and enforce `sessions:read`/`sessions:write` permissions as appropriate.
  - Remove any SvelteKit session `+server` modules and update backend tests in `apps/api/src/tests/routes/sessions-routes.test.ts` to cover list, revoke, and unauthorized flows.
  </action>
  <verify>npx vitest run apps/api --run tests/routes/sessions-routes.test.ts</verify>
  <done>Sessions are managed exclusively via Fastify with updated regression tests.</done>
</task>

<task type="auto">
  <name>Port setup wizard endpoints</name>
  <files>apps/api/src/routes/setup.ts</files>
  <action>
  - Move setup wizard handlers (test connection, test OCI, create admin) fully into Fastify with RBAC gating for follow-up operations.
  - Ensure `setupState` detection still works during first-run and update tests in `apps/api/src/tests/routes/setup-routes.test.ts` to cover positive/negative scenarios.
  - Update frontend tests (`apps/frontend/src/tests/phase4/setup-wizard.test.ts`) to mock Fastify responses instead of importing SvelteKit modules.
  </action>
  <verify>
    npx vitest run apps/api --run tests/routes/setup-routes.test.ts
    pnpm --filter @portal/frontend test --run tests/phase4/setup-wizard.test.ts
  </verify>
  <done>Setup wizard flows execute via Fastify endpoints with passing backend/frontend tests.</done>
</task>

<task type="auto">
  <name>Finalize admin MCP + webhook Fastify routes</name>
  <files>apps/api/src/routes/webhooks.ts</files>
  <action>
  - Ensure admin MCP, metrics, and webhook endpoints are served through Fastify (`apps/api/src/routes/admin/mcp.ts`, `apps/api/src/routes/admin/metrics.ts`, `apps/api/src/routes/webhooks.ts`).
  - Enforce `admin:all` and `webhooks:manage` permissions, returning structured errors.
  - Update backend tests in `apps/api/src/tests/routes/webhooks-routes.test.ts` and frontend tests in `apps/frontend/src/tests/phase6/webhooks.test.ts` to reference Fastify endpoints only.
  </action>
  <verify>
    npx vitest run apps/api --run tests/routes/webhooks-routes.test.ts
    pnpm --filter @portal/frontend test --run tests/phase6/webhooks.test.ts
  </verify>
  <done>Admin MCP/webhook endpoints rely solely on Fastify with refreshed tests.</done>
</task>

</tasks>

<verification>
- `npx vitest run apps/api --run tests/routes/sessions-routes.test.ts`
- `npx vitest run apps/api --run tests/routes/setup-routes.test.ts`
- `npx vitest run apps/api --run tests/routes/webhooks-routes.test.ts`
- `pnpm --filter @portal/frontend test --run tests/phase4/setup-wizard.test.ts`
- `pnpm --filter @portal/frontend test --run tests/phase6/webhooks.test.ts`
</verification>

<success_criteria>

- Sessions, setup, admin MCP, and webhooks are Fastify-only with passing regression tests.
- No frontend tests import SvelteKit server modules for these domains.
  </success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-rewrite/10-06-SUMMARY.md`
</output>
