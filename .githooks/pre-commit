#!/usr/bin/env bash
# =============================================================================
# Pre-commit hook: lint + type checks
#
# Runs ESLint and TypeScript checks on staged files. Fails fast on errors.
#
# Install: git config core.hooksPath .githooks
# =============================================================================
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Collect staged .ts/.svelte/.js files (exclude deleted)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d -- '*.ts' '*.svelte' '*.js' '*.tsx')

if [ -z "$STAGED_FILES" ]; then
  echo "[pre-commit] No staged TS/JS/Svelte files — skipping lint"
  exit 0
fi

echo "[pre-commit] Running lint and type checks..."

# Determine which workspaces have changed files
HAS_API=false
HAS_FRONTEND=false
HAS_SHARED=false

for file in $STAGED_FILES; do
  case "$file" in
    apps/api/*) HAS_API=true ;;
    apps/frontend/*) HAS_FRONTEND=true ;;
    packages/shared/*) HAS_SHARED=true ;;
  esac
done

FAILED=false

# Lint changed workspaces only (faster than full monorepo lint)
if [ "$HAS_API" = true ]; then
  echo "[pre-commit] Linting @portal/api..."
  if ! pnpm --filter @portal/api lint; then
    FAILED=true
  fi
fi

if [ "$HAS_FRONTEND" = true ]; then
  echo "[pre-commit] Linting @portal/frontend..."
  if ! pnpm --filter @portal/frontend lint; then
    FAILED=true
  fi
fi

if [ "$HAS_SHARED" = true ]; then
  echo "[pre-commit] Linting @portal/shared..."
  if ! pnpm --filter @portal/shared lint; then
    FAILED=true
  fi
fi

# Type checking — only for workspaces with changes
if [ "$HAS_API" = true ]; then
  echo "[pre-commit] Type-checking @portal/api..."
  if ! pnpm --filter @portal/api check; then
    FAILED=true
  fi
fi

if [ "$HAS_FRONTEND" = true ]; then
  echo "[pre-commit] Type-checking @portal/frontend..."
  if ! pnpm --filter @portal/frontend check; then
    FAILED=true
  fi
fi

if [ "$HAS_SHARED" = true ]; then
  echo "[pre-commit] Type-checking @portal/shared..."
  if ! pnpm --filter @portal/shared check; then
    FAILED=true
  fi
fi

# Format check on staged files only
echo "[pre-commit] Checking formatting..."
if ! echo "$STAGED_FILES" | xargs pnpm prettier --check 2>/dev/null; then
  echo "[pre-commit] Formatting issues found. Run: pnpm format"
  FAILED=true
fi

if [ "$FAILED" = true ]; then
  echo ""
  echo "[pre-commit] FAILED — fix errors above before committing"
  exit 1
fi

echo "[pre-commit] All checks passed"
