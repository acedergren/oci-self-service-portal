#!/usr/bin/env bash
# =============================================================================
# Pre-push hook: CodeRabbit, Semgrep, CodeQL security scans
#
# Scans files changed in the commits being pushed (not the full codebase).
# Each scanner runs independently — one failure does not skip the others.
#
# Skip: git push --no-verify (emergency only)
# Install: git config core.hooksPath .githooks
#
# Required tools:
#   - semgrep (brew install semgrep)
#   - codeql  (brew install codeql)
#   - claude  (for CodeRabbit via claude skill)
# =============================================================================
set -uo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Parse the range of commits being pushed (stdin from git)
FAILED=false
COMMIT_RANGE=""

while read -r local_ref local_sha remote_ref remote_sha; do
  if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    # Branch being deleted — nothing to scan
    continue
  fi

  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch — scan all commits since main
    MAIN_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")
    MERGE_BASE=$(git merge-base "$MAIN_BRANCH" "$local_sha" 2>/dev/null || echo "")
    if [ -n "$MERGE_BASE" ]; then
      COMMIT_RANGE="$MERGE_BASE..$local_sha"
    else
      COMMIT_RANGE="$local_sha"
    fi
  else
    COMMIT_RANGE="$remote_sha..$local_sha"
  fi
done

if [ -z "$COMMIT_RANGE" ]; then
  echo "[pre-push] No commits to scan — skipping"
  exit 0
fi

# Get files changed in the commits being pushed
CHANGED_FILES=$(git diff --name-only "$COMMIT_RANGE" -- '*.ts' '*.js' '*.svelte' '*.tsx' 2>/dev/null || true)

if [ -z "$CHANGED_FILES" ]; then
  echo "[pre-push] No TS/JS/Svelte files in push range — skipping scans"
  exit 0
fi

FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
echo "[pre-push] Scanning $FILE_COUNT changed files in $COMMIT_RANGE"
echo ""

# Determine scan directories from changed files
SCAN_DIRS=""
if echo "$CHANGED_FILES" | grep -q "^apps/api/"; then
  SCAN_DIRS="$SCAN_DIRS apps/api/src/"
fi
if echo "$CHANGED_FILES" | grep -q "^apps/frontend/"; then
  SCAN_DIRS="$SCAN_DIRS apps/frontend/src/"
fi
if echo "$CHANGED_FILES" | grep -q "^packages/shared/"; then
  SCAN_DIRS="$SCAN_DIRS packages/shared/src/"
fi

if [ -z "$SCAN_DIRS" ]; then
  echo "[pre-push] Changed files not in scannable directories — skipping"
  exit 0
fi

# ---- 1. Semgrep ----
echo "=== Semgrep Security Scan ==="
if command -v semgrep &>/dev/null; then
  SEMGREP_OUTPUT=$(semgrep scan --config auto --severity ERROR --severity WARNING \
    --quiet --no-git-ignore $SCAN_DIRS 2>&1) || true

  FINDING_COUNT=$(echo "$SEMGREP_OUTPUT" | grep -c "^.*:.*:.*" 2>/dev/null || echo "0")

  if [ -n "$SEMGREP_OUTPUT" ] && [ "$FINDING_COUNT" -gt 0 ]; then
    echo "[semgrep] Found potential issues:"
    echo "$SEMGREP_OUTPUT"
    echo ""
    echo "[semgrep] WARNING: $FINDING_COUNT finding(s). Review above before pushing."
    echo "[semgrep] If false positives, add '# nosemgrep' inline comment."
    FAILED=true
  else
    echo "[semgrep] Clean - no findings"
  fi
else
  echo "[semgrep] SKIPPED — semgrep not installed (brew install semgrep)"
fi
echo ""

# ---- 2. CodeQL ----
echo "=== CodeQL Security Analysis ==="
if command -v codeql &>/dev/null; then
  CODEQL_DB_DIR=$(mktemp -d)
  trap 'rm -rf "$CODEQL_DB_DIR"' EXIT

  echo "[codeql] Creating database..."
  if codeql database create "$CODEQL_DB_DIR/db" \
    --language=javascript \
    --source-root="$REPO_ROOT" \
    --overwrite \
    --quiet 2>/dev/null; then

    echo "[codeql] Running security analysis..."
    CODEQL_RESULTS="$CODEQL_DB_DIR/results.sarif"

    if codeql database analyze "$CODEQL_DB_DIR/db" \
      --format=sarif-latest \
      --output="$CODEQL_RESULTS" \
      --quiet \
      codeql/javascript-queries:codeql-suites/javascript-security-extended.qls 2>/dev/null; then

      RESULT_COUNT=$(python3 -c "
import json, sys
with open('$CODEQL_RESULTS') as f:
    sarif = json.load(f)
    count = sum(len(run.get('results', [])) for run in sarif.get('runs', []))
    print(count)
" 2>/dev/null || echo "0")

      if [ "$RESULT_COUNT" -gt 0 ]; then
        echo "[codeql] WARNING: $RESULT_COUNT finding(s):"
        python3 -c "
import json
with open('$CODEQL_RESULTS') as f:
    sarif = json.load(f)
    for run in sarif.get('runs', []):
        for result in run.get('results', []):
            rule = result.get('ruleId', 'unknown')
            msg = result.get('message', {}).get('text', '')[:120]
            locs = result.get('locations', [])
            loc = ''
            if locs:
                phys = locs[0].get('physicalLocation', {})
                uri = phys.get('artifactLocation', {}).get('uri', '')
                line = phys.get('region', {}).get('startLine', '?')
                loc = f'{uri}:{line}'
            print(f'  [{rule}] {loc}: {msg}')
" 2>/dev/null
        FAILED=true
      else
        echo "[codeql] Clean - no findings"
      fi
    else
      echo "[codeql] Analysis failed (non-fatal) — check codeql installation"
    fi
  else
    echo "[codeql] Database creation failed (non-fatal) — check codeql installation"
  fi
else
  echo "[codeql] SKIPPED — codeql not installed (brew install codeql)"
fi
echo ""

# ---- 3. CodeRabbit ----
echo "=== CodeRabbit AI Review ==="
if command -v claude &>/dev/null; then
  echo "[coderabbit] Triggering CodeRabbit review via Claude skill..."
  # CodeRabbit runs as a Claude skill — it reviews the diff
  # This is best triggered after push as a PR review, but we can
  # run a local review on the diff
  DIFF_FILE=$(mktemp)
  git diff "$COMMIT_RANGE" > "$DIFF_FILE" 2>/dev/null || true

  if [ -s "$DIFF_FILE" ]; then
    echo "[coderabbit] Diff captured ($FILE_COUNT files). CodeRabbit review will run on PR."
    echo "[coderabbit] For local review: claude '/coderabbit:review'"
  else
    echo "[coderabbit] No diff to review"
  fi
  rm -f "$DIFF_FILE"
else
  echo "[coderabbit] NOTE — Run 'claude /coderabbit:review' for AI code review"
fi
echo ""

# ---- 4. Tests (bonus — catches broken code before push) ----
echo "=== Running Tests ==="
if ! pnpm test 2>&1; then
  echo "[tests] FAILED — fix failing tests before pushing"
  FAILED=true
else
  echo "[tests] All tests passed"
fi
echo ""

# ---- Summary ----
if [ "$FAILED" = true ]; then
  echo "============================================"
  echo " PRE-PUSH CHECKS FAILED"
  echo " Fix the issues above before pushing."
  echo " Emergency skip: git push --no-verify"
  echo "============================================"
  exit 1
fi

echo "[pre-push] All security scans passed"
