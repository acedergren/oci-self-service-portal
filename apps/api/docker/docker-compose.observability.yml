version: '3.8'

services:
  tempo:
    image: grafana/tempo:latest
    command: ['-config.file=/etc/tempo.yml']
    volumes:
      - ./tempo/tempo.yml:/etc/tempo.yml:ro
      - tempo-data:/tmp/tempo
    ports:
      - '4317:4317' # OTLP gRPC
      - '4318:4318' # OTLP HTTP
      - '3200:3200' # Tempo HTTP
    networks:
      - observability
    read_only: true
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:mode=1777,size=1G

  grafana:
    image: grafana/grafana:latest
    ports:
      - '3001:3000'
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    networks:
      - observability
    depends_on:
      - tempo
    read_only: true
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:mode=1777,size=512M
      - /run:mode=0755,size=100M

volumes:
  tempo-data:
  grafana-data:

networks:
  observability:
    driver: bridge
