# =============================================================================
# OCI Self-Service Portal - Multi-Service Docker Compose
# =============================================================================
# Phase 9: Nginx TLS termination + Fastify backend + SvelteKit frontend
#
# Usage:
#   cp .env.example .env  # then fill in values
#   docker compose up -d
#   docker compose logs -f
#
# TLS certificates:
#   Place TLS cert + key in the path set by TLS_CERT_PATH / TLS_KEY_PATH,
#   or use the default ./certs/ directory:
#     mkdir -p certs
#     cp fullchain.pem certs/  # TLS certificate chain
#     cp privkey.pem certs/    # Private key
#
#   For development, generate a self-signed cert:
#     openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#       -keyout certs/privkey.pem -out certs/fullchain.pem \
#       -subj "/CN=localhost"
#
# Build context is the monorepo root (..) because packages/shared
# is a sibling directory resolved during the build.
# =============================================================================

version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy — TLS termination
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:1.27-alpine
    container_name: portal-nginx
    restart: unless-stopped
    read_only: true

    security_opt:
      - no-new-privileges:true

    ports:
      - '${HTTPS_PORT:-443}:443'
      - '${HTTP_PORT:-80}:80'

    volumes:
      # Nginx configuration (read-only)
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

      # TLS certificates (read-only)
      - ${TLS_CERT_PATH:-./certs}/fullchain.pem:/etc/nginx/certs/fullchain.pem:ro
      - ${TLS_KEY_PATH:-./certs}/privkey.pem:/etc/nginx/certs/privkey.pem:ro

      # DH parameters for forward secrecy (required — see README.md Prerequisites)
      - ${DH_PARAMS_PATH:-./certs/dhparam.pem}:/etc/nginx/certs/dhparam.pem:ro

      # ACME challenge webroot for Let's Encrypt HTTP-01 validation
      - ./certbot-www:/var/www/certbot:ro

    # tmpfs for nginx runtime directories (pid, cache, logs) since root fs is read-only
    tmpfs:
      - /var/cache/nginx:size=64m
      - /var/run:size=1m
      - /tmp:size=16m

    networks:
      - portal-network

    depends_on:
      api:
        condition: service_healthy
      frontend:
        condition: service_healthy

    deploy:
      resources:
        limits:
          memory: 256m
          cpus: '0.25'

    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:80/nginx-health']
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ---------------------------------------------------------------------------
  # Certbot (optional profile) — Let's Encrypt renewal loop
  # ---------------------------------------------------------------------------
  certbot:
    image: certbot/certbot:latest
    container_name: portal-certbot
    restart: unless-stopped
    read_only: true
    profiles: ['letsencrypt']

    security_opt:
      - no-new-privileges:true

    environment:
      - TLS_DOMAIN=${TLS_DOMAIN:-}
      - CERTBOT_EMAIL=${CERTBOT_EMAIL:-}

    volumes:
      # Same path used by nginx TLS_CERT_PATH/TLS_KEY_PATH defaults
      - ${TLS_CERT_PATH:-./certs}:/etc/letsencrypt
      - ./certbot-www:/var/www/certbot

    # tmpfs for certbot runtime dirs since root fs is read-only
    tmpfs:
      - /var/log/letsencrypt:size=16m
      - /tmp:size=16m

    entrypoint: /bin/sh
    command:
      - -c
      - |
        trap exit TERM
        while :; do
          echo "[$(date -Iseconds)] Starting certbot renewal check"
          certbot renew --webroot -w /var/www/certbot --quiet || true
          if [ -n "$$TLS_DOMAIN" ] && [ -f "/etc/letsencrypt/live/$$TLS_DOMAIN/fullchain.pem" ] && [ -f "/etc/letsencrypt/live/$$TLS_DOMAIN/privkey.pem" ]; then
            cp "/etc/letsencrypt/live/$$TLS_DOMAIN/fullchain.pem" /etc/letsencrypt/fullchain.pem
            cp "/etc/letsencrypt/live/$$TLS_DOMAIN/privkey.pem" /etc/letsencrypt/privkey.pem
            echo "[$(date -Iseconds)] Certificates copied for $$TLS_DOMAIN"
          else
            echo "[$(date -Iseconds)] WARNING: Certificate copy skipped (TLS_DOMAIN=$${TLS_DOMAIN:-unset})"
          fi
          sleep 12h & wait $$!
        done

    networks:
      - portal-network

  # ---------------------------------------------------------------------------
  # Fastify Backend API (internal only — not exposed to host)
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/phase9/Dockerfile.api
    container_name: portal-api
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    # No host port binding — only accessible via nginx on the portal-network
    expose:
      - '3001'

    env_file:
      - .env

    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - LOG_LEVEL=info

      # Oracle Database (via environment or .env)
      # - DATABASE_URL=...
      # - ORACLE_USER=ADMIN
      # - ORACLE_DSN=langflowdb_high
      # - ORACLE_WALLET_LOCATION=/wallets/langflow

      # OCI Configuration
      - OCI_REGION=${OCI_REGION:-eu-frankfurt-1}
      - OCI_AUTH_METHOD=config_file

      # Auth (must be set in .env)
      # - BETTER_AUTH_SECRET=...

    volumes:
      # Persistent application data
      - api_data:/app/data

      # OCI CLI configuration (read-only)
      - ~/.oci:/home/portal/.oci:ro

      # Oracle wallet for database connectivity (read-only)
      - ${WALLET_PATH:-/data/wallets}:/wallets:ro

    networks:
      - portal-network

    deploy:
      resources:
        limits:
          memory: 2g
          cpus: '1.0'
        reservations:
          memory: 512m
          cpus: '0.5'

    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ---------------------------------------------------------------------------
  # SvelteKit Frontend (internal only — not exposed to host)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/phase9/Dockerfile.frontend
    container_name: portal-frontend
    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    # No host port binding — only accessible via nginx on the portal-network
    expose:
      - '3000'

    env_file:
      - .env

    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0

      # API connection (internal Docker network)
      - API_URL=http://api:3001

      # Public API URL (browser requests go through nginx)
      - PUBLIC_API_URL=${PUBLIC_API_URL:-https://localhost/api}

    volumes:
      # Build cache (optional, for faster rebuilds)
      - frontend_data:/app/data

    networks:
      - portal-network

    depends_on:
      api:
        condition: service_healthy

    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '0.5'
        reservations:
          memory: 256m
          cpus: '0.25'

    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

# =============================================================================
# Networks
# =============================================================================
networks:
  portal-network:
    driver: bridge
    name: portal-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  api_data:
    name: portal-api-data
  frontend_data:
    name: portal-frontend-data
