# =============================================================================
# OCI Self-Service Portal - Development Docker Compose Override
# =============================================================================
# Enables hot-reload for faster development iteration.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# =============================================================================

version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # Fastify Backend API (Development Mode)
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ../..
      dockerfile: infrastructure/docker/phase9/Dockerfile.api
      target: builder # Stop at builder stage to keep TypeScript source

    command: pnpm --filter @portal/api dev

    environment:
      - NODE_ENV=development
      - LOG_LEVEL=debug

    volumes:
      # Mount source for hot-reload
      - ../../apps/api:/app/apps/api
      - ../../packages/shared:/app/packages/shared

      # Prevent overwriting node_modules
      - /app/node_modules
      - /app/apps/api/node_modules
      - /app/packages/shared/node_modules

    ports:
      # Expose Node.js inspector for debugging
      - '9229:9229'

  # ---------------------------------------------------------------------------
  # SvelteKit Frontend (Development Mode)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ../..
      dockerfile: infrastructure/docker/phase9/Dockerfile.frontend
      target: builder # Stop at builder stage to keep source

    command: pnpm --filter @portal/frontend dev --host

    environment:
      - NODE_ENV=development

    volumes:
      # Mount source for hot-reload
      - ../../apps/frontend:/app/apps/frontend
      - ../../packages/shared:/app/packages/shared

      # Prevent overwriting node_modules
      - /app/node_modules
      - /app/apps/frontend/node_modules
      - /app/packages/shared/node_modules

    ports:
      # SvelteKit dev server (Vite)
      - '5173:5173'
      # Vite HMR WebSocket
      - '24678:24678'
